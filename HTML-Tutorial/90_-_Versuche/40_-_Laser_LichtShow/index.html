<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>40 - Laser LichtShow</title>
    <style>
      pre {background-color:#BBBBFF; color:#000000; font-family: Fixedsys,Courier,monospace; padding:10px;}
    </style>
  </head>
  <body bgcolor="#DDDDFF">
    <b><h1>90 - Versuche</h1></b>
    <b><h2>40 - Laser LichtShow</h2></b>
<img src="image.png" alt="Selfhtml"><br><br>
Zum Schluss eine kleine Spielerei: Hier wird ein Mandelbrot im Shader (also auf der GPU) berechnet.<br>
Mit der CPU hatte ich noch keine so schnelle Berechnung hingekriegt, trotz Assembler.<br>
<br>
Anmerkung: Bei diesem Beispiel geht es nicht um mathematische Hintegründe, sondern es soll legentlich demonstrieren, das man mit Shader-Programs sehr komplexe Berechnungen machen kann.<br>
<br>
Der Lazarus-Code ist nichts besonderes, es wird nur ein Rechteck gerendert und anschliessend mit einer Matrix gedreht. Was eine Matrix ist, wird im Kapitel Matrix beschrieben.<br>
<b>Achtung:</b> Eine lahme Grafikkarte kann bei Vollbild ins Stockern kommen.<br>
Zur Beschleunigung kann der Wert <b>#define depth 1000.0</b> im Fragment-Shader verkleinert werden.<br>
<hr><br>
<b>Vertex-Shader:</b><br>
<pre><code><b><font color="#008800">#version</font></b> <font color="#0077BB">330</font>

<b><font color="0000BB">layout</font></b> (location = <font color="#0077BB">10</font>) <b><font color="0000BB">in</font></b> <b><font color="0000BB">vec3</font></b> inPos;   <i><font color="#FFFF00">// Vertex-Koordinaten</font></i>

<b><font color="0000BB">out</font></b> <b><font color="0000BB">vec2</font></b> pos;                           <i><font color="#FFFF00">// Koordinaten für den Fragment-Shader</font></i>

<b><font color="0000BB">void</font></b> main(<b><font color="0000BB">void</font></b>) {
  gl_Position = <b><font color="0000BB">vec4</font></b>(inPos, <font color="#0077BB">1</font>.<font color="#0077BB">0</font>);
  pos = gl_Position.xy;                 <i><font color="#FFFF00">// XY an Fragment-Shader</font></i>
}
</pre></code>
<hr><br>
<b>Fragment-Shader:</b><br>
<br>
Hier steckt die ganze Berechnung für das Mandelbrot.<br>
<pre><code><b><font color="#008800">#version</font></b> <font color="#0077BB">330</font>
<b><font color="#008800">#define</font></b> depth <font color="#0077BB">1000</font>.<font color="#0077BB">0</font>

<b><font color="#008800">#define</font></b> Pi				<font color="#0077BB">3</font>.<font color="#0077BB">14159265358979</font>

<b><font color="#008800">#define</font></b> HorizontalAmplitude		<font color="#0077BB">0</font>.<font color="#0077BB">30</font>
<b><font color="#008800">#define</font></b> VerticleAmplitude		<font color="#0077BB">0</font>.<font color="#0077BB">20</font>
<b><font color="#008800">#define</font></b> HorizontalSpeed			<font color="#0077BB">0</font>.<font color="#0077BB">90</font>
<b><font color="#008800">#define</font></b> VerticleSpeed			<font color="#0077BB">1</font>.<font color="#0077BB">50</font>
<b><font color="#008800">#define</font></b> ParticleMinSize			<font color="#0077BB">1</font>.<font color="#0077BB">76</font>
<b><font color="#008800">#define</font></b> ParticleMaxSize			<font color="#0077BB">1</font>.<font color="#0077BB">61</font>
<b><font color="#008800">#define</font></b> ParticleBreathingSpeed		<font color="#0077BB">0</font>.<font color="#0077BB">30</font>
<b><font color="#008800">#define</font></b> ParticleColorChangeSpeed	<font color="#0077BB">0</font>.<font color="#0077BB">70</font>
<b><font color="#008800">#define</font></b> ParticleCount			<font color="#0077BB">2</font>.<font color="#0077BB">0</font>
<b><font color="#008800">#define</font></b> ParticleColor1			<b><font color="0000BB">vec3</font></b>(<font color="#0077BB">9</font>.<font color="#0077BB">0</font>, <font color="#0077BB">5</font>.<font color="#0077BB">0</font>, <font color="#0077BB">3</font>.<font color="#0077BB">0</font>)
<b><font color="#008800">#define</font></b> ParticleColor2			<b><font color="0000BB">vec3</font></b>(<font color="#0077BB">1</font>.<font color="#0077BB">0</font>, <font color="#0077BB">3</font>.<font color="#0077BB">0</font>, <font color="#0077BB">9</font>.<font color="#0077BB">0</font>)

<b><font color="0000BB">in</font></b> <b><font color="0000BB">vec2</font></b> pos;       <i><font color="#FFFF00">// Interpolierte Koordinaten vom Vertex-Shader</font></i>

<b><font color="0000BB">out</font></b> <b><font color="0000BB">vec4</font></b> outColor;

<b><font color="0000BB">float</font></b> LichtOeffnung = <font color="#0077BB">16</font>;
<b><font color="0000BB">uniform</font></b> <b><font color="0000BB">float</font></b>[<font color="#0077BB">5</font>] LichtRichtung;

<b><font color="0000BB">uniform</font></b> <b><font color="0000BB">vec2</font></b> LichtPosition;

<b><font color="0000BB">uniform</font></b> <b><font color="0000BB">float</font></b> time;
<b><font color="0000BB">uniform</font></b> <b><font color="0000BB">vec2</font></b> resolution;

<b><font color="0000BB">bool</font></b> isCone(<b><font color="0000BB">vec2</font></b> p, <b><font color="0000BB">float</font></b> LichtRichtung) {
  <b><font color="0000BB">vec2</font></b> lr;
  lr.x = sin(LichtRichtung);
  lr.y = cos(LichtRichtung);

  <b><font color="0000BB">float</font></b> winkel;
  lr = normalize(lr);
  <b><font color="0000BB">vec2</font></b> lp = <b><font color="0000BB">vec2</font></b>(p - LichtPosition);
  lp = normalize(lp);
  winkel = dot(lr, lp);

  <b><font color="0000BB">return</font></b> (winkel > cos(<font color="#0077BB">3</font>.<font color="#0077BB">14</font> / LichtOeffnung));
}

<b><font color="0000BB">float</font></b> hash( <b><font color="0000BB">float</font></b> x ) {
  <b><font color="0000BB">return</font></b> fract( sin( x ) * <font color="#0077BB">43758</font>.<font color="#0077BB">5453</font> );
}

<b><font color="0000BB">float</font></b> noise( <b><font color="0000BB">vec2</font></b> uv ) {
  <b><font color="0000BB">vec3</font></b> x = <b><font color="0000BB">vec3</font></b>( uv.xy, <font color="#0077BB">0</font>.<font color="#0077BB">0</font> );

  <b><font color="0000BB">vec3</font></b> p = floor( x );
  <b><font color="0000BB">vec3</font></b> f = fract( x );

  f = f * f * (<font color="#0077BB">3</font>.<font color="#0077BB">0</font> - <font color="#0077BB">2</font>.<font color="#0077BB">0</font> * f);

  <b><font color="0000BB">float</font></b> offset = <font color="#0077BB">57</font>.<font color="#0077BB">0</font>;
  <b><font color="0000BB">float</font></b> n = dot( p, <b><font color="0000BB">vec3</font></b>(<font color="#0077BB">1</font>.<font color="#0077BB">0</font>, offset, offset*<font color="#0077BB">2</font>.<font color="#0077BB">0</font>) );

  <b><font color="0000BB">return</font></b> mix(mix(mix(hash( n + <font color="#0077BB">0</font>.<font color="#0077BB">0</font> ), hash( n + <font color="#0077BB">1</font>.<font color="#0077BB">0</font> ), f.x ),
         mix( hash( n + offset), hash( n + offset + <font color="#0077BB">1</font>.<font color="#0077BB">0</font>), f.x ), f.y ),
         mix(mix( hash( n + offset * <font color="#0077BB">2</font>.<font color="#0077BB">0</font>), hash( n + offset * <font color="#0077BB">2</font>.<font color="#0077BB">0</font> + <font color="#0077BB">1</font>.<font color="#0077BB">0</font>), f.x),
      	 mix( hash( n + offset * <font color="#0077BB">3</font>.<font color="#0077BB">0</font>), hash( n + offset * <font color="#0077BB">3</font>.<font color="#0077BB">0</font> + <font color="#0077BB">1</font>.<font color="#0077BB">0</font>), f.x), f.y), f.z);
}

<b><font color="0000BB">float</font></b> snoise( <b><font color="0000BB">vec2</font></b> uv ) {
  <b><font color="0000BB">return</font></b> noise( uv ) * <font color="#0077BB">2</font>.<font color="#0077BB">0</font> - <font color="#0077BB">1</font>.<font color="#0077BB">0</font>;
}


<b><font color="0000BB">float</font></b> perlinNoise( <b><font color="0000BB">vec2</font></b> uv ) {
  <b><font color="0000BB">float</font></b> n = noise( uv *   <font color="#0077BB">1</font>.<font color="#0077BB">0</font> )	* <font color="#0077BB">128</font>.<font color="#0077BB">0</font> +
            noise( uv *   <font color="#0077BB">2</font>.<font color="#0077BB">0</font> )	*  <font color="#0077BB">64</font>.<font color="#0077BB">0</font> +
            noise( uv *   <font color="#0077BB">4</font>.<font color="#0077BB">0</font> )	*  <font color="#0077BB">32</font>.<font color="#0077BB">0</font> +
            noise( uv *   <font color="#0077BB">8</font>.<font color="#0077BB">0</font> )	*  <font color="#0077BB">16</font>.<font color="#0077BB">0</font> +
            noise( uv *  <font color="#0077BB">16</font>.<font color="#0077BB">0</font> )	*   <font color="#0077BB">8</font>.<font color="#0077BB">0</font> +
            noise( uv *  <font color="#0077BB">32</font>.<font color="#0077BB">0</font> )	*   <font color="#0077BB">4</font>.<font color="#0077BB">0</font> +
            noise( uv *  <font color="#0077BB">64</font>.<font color="#0077BB">0</font> )	*   <font color="#0077BB">2</font>.<font color="#0077BB">0</font> +
            noise( uv * <font color="#0077BB">128</font>.<font color="#0077BB">0</font> ) *   <font color="#0077BB">1</font>.<font color="#0077BB">0</font>;

  <b><font color="0000BB">float</font></b> noiseVal = n / ( <font color="#0077BB">255</font>.<font color="#0077BB">0</font> );
  noiseVal = abs(noiseVal * <font color="#0077BB">2</font>.<font color="#0077BB">0</font> - <font color="#0077BB">1</font>.<font color="#0077BB">0</font>);

  <b><font color="0000BB">return</font></b> 	noiseVal;
}

<b><font color="0000BB">float</font></b> fBm( <b><font color="0000BB">vec2</font></b> uv, <b><font color="0000BB">float</font></b> lacunarity, <b><font color="0000BB">float</font></b> gain )
{
  <b><font color="0000BB">float</font></b> sum = <font color="#0077BB">0</font>.<font color="#0077BB">0</font>;
  <b><font color="0000BB">float</font></b> amp = <font color="#0077BB">7</font>.<font color="#0077BB">0</font>;

  <b><font color="0000BB">for</font></b>( <b><font color="0000BB">int</font></b> i = <font color="#0077BB">0</font>; i < <font color="#0077BB">2</font>; ++i ) {
    sum += ( perlinNoise( uv ) ) * amp;
    amp *= gain;
    uv *= lacunarity;
  }

  <b><font color="0000BB">return</font></b> sum;
}

<b><font color="0000BB">vec3</font></b> particles( <b><font color="0000BB">vec2</font></b> pos ) {
  <b><font color="0000BB">vec3</font></b> c = <b><font color="0000BB">vec3</font></b>( <font color="#0077BB">0</font>, <font color="#0077BB">0</font>, <font color="#0077BB">0</font> );

  <b><font color="0000BB">float</font></b> noiseFactor = fBm( pos, <font color="#0077BB">0</font>.<font color="#0077BB">01</font>, <font color="#0077BB">0</font>.<font color="#0077BB">1</font>);

  <b><font color="0000BB">for</font></b>( <b><font color="0000BB">float</font></b> i = <font color="#0077BB">1</font>.<font color="#0077BB">0</font>; i < ParticleCount+<font color="#0077BB">1</font>.<font color="#0077BB">0</font>; ++i ) {
    <b><font color="0000BB">float</font></b> cs = cos( time * HorizontalSpeed * (i/ParticleCount) + noiseFactor ) * HorizontalAmplitude;
    <b><font color="0000BB">float</font></b> ss = sin( time * VerticleSpeed   * (i/ParticleCount) + noiseFactor ) * VerticleAmplitude;
    <b><font color="0000BB">vec2</font></b> origin = <b><font color="0000BB">vec2</font></b>( cs , ss );

    <b><font color="0000BB">float</font></b> t = sin( time * ParticleBreathingSpeed * i ) * <font color="#0077BB">0</font>.<font color="#0077BB">5</font> + <font color="#0077BB">0</font>.<font color="#0077BB">5</font>;
    <b><font color="0000BB">float</font></b> particleSize = mix( ParticleMinSize, ParticleMaxSize, t );
    <b><font color="0000BB">float</font></b> d = clamp( sin( length( pos - origin )  + particleSize ), <font color="#0077BB">0</font>.<font color="#0077BB">0</font>, particleSize);

    <b><font color="0000BB">float</font></b> t2 = sin( time * ParticleColorChangeSpeed * i ) * <font color="#0077BB">0</font>.<font color="#0077BB">5</font> + <font color="#0077BB">0</font>.<font color="#0077BB">5</font>;
    <b><font color="0000BB">vec3</font></b> color = mix( ParticleColor1, ParticleColor2, t2 );
    c += color * pow( d, <font color="#0077BB">10</font>.<font color="#0077BB">0</font> );
  }

  <b><font color="0000BB">return</font></b> c;
}


<b><font color="0000BB">float</font></b> line( <b><font color="0000BB">vec2</font></b> a, <b><font color="0000BB">vec2</font></b> b, <b><font color="0000BB">vec2</font></b> p ) {
  <b><font color="0000BB">vec2</font></b> aTob = b - a;
  <b><font color="0000BB">vec2</font></b> aTop = p - a;

  <b><font color="0000BB">float</font></b> t = dot( aTop, aTob ) / dot( aTob, aTob);

  t = clamp( t, <font color="#0077BB">0</font>.<font color="#0077BB">0</font>, <font color="#0077BB">1</font>.<font color="#0077BB">0</font>);

  <b><font color="0000BB">float</font></b> d = length( p - (a + aTob * t) );
  d = <font color="#0077BB">1</font>.<font color="#0077BB">0</font> / d;

  <b><font color="0000BB">return</font></b> clamp( d, <font color="#0077BB">0</font>.<font color="#0077BB">0</font>, <font color="#0077BB">1</font>.<font color="#0077BB">0</font> );
}


<b><font color="0000BB">void</font></b> main(<b><font color="0000BB">void</font></b>) {
  <b><font color="0000BB">float</font></b> aspectRatio = resolution.x / resolution.y;

  <b><font color="0000BB">vec2</font></b> uv = ( gl_FragCoord.xy / resolution.xy );

  <b><font color="0000BB">vec2</font></b> signedUV = uv * <font color="#0077BB">2</font>.<font color="#0077BB">0</font> - <font color="#0077BB">1</font>.<font color="#0077BB">0</font>;
  signedUV.x *= aspectRatio;
  signedUV.y *= -<font color="#0077BB">1</font>.<font color="#0077BB">0</font>;

  <b><font color="0000BB">float</font></b> scale = <font color="#0077BB">100</font>.<font color="#0077BB">0</font>;
  <b><font color="0000BB">const</font></b> <b><font color="0000BB">float</font></b> v = <font color="#0077BB">90</font>.<font color="#0077BB">0</font>;
  <b><font color="0000BB">vec3</font></b> finalColor = <b><font color="0000BB">vec3</font></b>( <font color="#0077BB">0</font>.<font color="#0077BB">0</font> );

  finalColor = (particles( sin( abs(signedUV) ) ) * length(signedUV)) * <font color="#0077BB">0</font>.<font color="#0077BB">20</font>;

  <b><font color="0000BB">vec2</font></b> _uv = signedUV;
  signedUV.x /= cos(time);
  <b><font color="0000BB">float</font></b> t;
  <b><font color="0000BB">for</font></b> (<b><font color="0000BB">float</font></b> i=<font color="#0077BB">0</font>.<font color="#0077BB">0</font>; i<<font color="#0077BB">5</font>.<font color="#0077BB">0</font>; i+=<font color="#0077BB">1</font>.<font color="#0077BB">0</font>) {
    <b><font color="0000BB">float</font></b> freq = mix( <font color="#0077BB">0</font>.<font color="#0077BB">4</font>, <font color="#0077BB">1</font>.<font color="#0077BB">2</font>, sin(time + <font color="#0077BB">10</font>.<font color="#0077BB">0</font> * i) * <font color="#0077BB">0</font>.<font color="#0077BB">5</font> + <font color="#0077BB">0</font>.<font color="#0077BB">5</font> );
    <b><font color="0000BB">float</font></b> ang =  (i / <font color="#0077BB">5</font>.<font color="#0077BB">0</font> * <font color="#0077BB">2</font>.<font color="#0077BB">0</font> - <font color="#0077BB">0</font>.<font color="#0077BB">1</font>) * Pi;
    <b><font color="0000BB">float</font></b> ang2 =  ((i + <font color="#0077BB">2</font>.<font color="#0077BB">0</font>) / <font color="#0077BB">5</font>.<font color="#0077BB">0</font> * <font color="#0077BB">2</font>.<font color="#0077BB">0</font> - <font color="#0077BB">0</font>.<font color="#0077BB">1</font>) * Pi;
    t = line( <b><font color="0000BB">vec2</font></b>(cos(ang), sin(ang)) * v, <b><font color="0000BB">vec2</font></b>(cos(ang2), sin(ang2) + <font color="#0077BB">0</font>.<font color="#0077BB">05</font>) * v, signedUV * scale );
    finalColor += <b><font color="0000BB">vec3</font></b>( <font color="#0077BB">8</font>.<font color="#0077BB">0</font> * t, <font color="#0077BB">2</font>.<font color="#0077BB">0</font> * t, <font color="#0077BB">4</font>.<font color="#0077BB">0</font> * t) * freq;
  }

  signedUV = _uv;
  signedUV.x /= sin(time);

  scale = scale * <font color="#0077BB">1</font>.<font color="#0077BB">8</font>;
  t = line( <b><font color="0000BB">vec2</font></b>(<font color="#0077BB">0</font>.<font color="#0077BB">0</font>, v * <font color="#0077BB">0</font>.<font color="#0077BB">4</font>), <b><font color="0000BB">vec2</font></b>(<font color="#0077BB">0</font>.<font color="#0077BB">0</font>, -v * <font color="#0077BB">0</font>.<font color="#0077BB">3</font>), signedUV * scale );
  finalColor += <b><font color="0000BB">vec3</font></b>( <font color="#0077BB">8</font>.<font color="#0077BB">0</font> * t, <font color="#0077BB">4</font>.<font color="#0077BB">0</font> * t, <font color="#0077BB">2</font>.<font color="#0077BB">0</font> * t) * <font color="#0077BB">0</font>.<font color="#0077BB">5</font>;

  t = line( <b><font color="0000BB">vec2</font></b>(-v * <font color="#0077BB">0</font>.<font color="#0077BB">2</font>, -v*<font color="#0077BB">0</font>.<font color="#0077BB">1</font>), <b><font color="0000BB">vec2</font></b>(v * <font color="#0077BB">0</font>.<font color="#0077BB">2</font>, -v*<font color="#0077BB">0</font>.<font color="#0077BB">1</font>), signedUV * scale );
  finalColor += <b><font color="0000BB">vec3</font></b>( <font color="#0077BB">8</font>.<font color="#0077BB">0</font> * t, <font color="#0077BB">4</font>.<font color="#0077BB">0</font> * t, <font color="#0077BB">2</font>.<font color="#0077BB">0</font> * t) * <font color="#0077BB">0</font>.<font color="#0077BB">4</font>;


  finalColor /= <font color="#0077BB">15</font>;
  outColor = <b><font color="0000BB">vec4</font></b>( finalColor, <font color="#0077BB">1</font>.<font color="#0077BB">0</font> );

   <b><font color="0000BB">for</font></b> (<b><font color="0000BB">int</font></b> i = <font color="#0077BB">0</font>; i <= <font color="#0077BB">5</font>; i++) {
     <b><font color="0000BB">if</font></b> (isCone(pos, LichtRichtung[i])) {
       outColor *= <font color="#0077BB">5</font>;
     }
   }
}
</pre></code>

    <br><br><br>
<h2><a href="../../index.html">zurück</a></h2>
  </body>
</html>
